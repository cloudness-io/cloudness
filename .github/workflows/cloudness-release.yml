name: Cloudness Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-cloudness-app:
    name: Cloudness App
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_build-app.yml
    with:
      enable-cache: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  build-cloudness-builder:
    name: Builder Plugin
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_build-builder.yml
    with:
      enable-cache: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  upload-scripts:
    name: Upload Scripts
    needs: [build-cloudness-app, build-cloudness-builder]
    permissions:
      contents: read
    uses: ./.github/workflows/_upload-scripts.yml
    secrets:
      SCRIPTS_BUCKET_ACCOUNT_ID: ${{ secrets.SCRIPTS_BUCKET_ACCOUNT_ID }}
      SCRIPTS_BUCKET_ACCESS_KEY_ID: ${{ secrets.SCRIPTS_BUCKET_ACCESS_KEY_ID }}
      SCRIPTS_BUCKET_SECRET_ACCESS_KEY: ${{ secrets.SCRIPTS_BUCKET_SECRET_ACCESS_KEY }}
      SCRIPTS_BUCKET_NAME: ${{ secrets.SCRIPTS_BUCKET_NAME }}
