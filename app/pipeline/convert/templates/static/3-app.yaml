{{ if not .HasState }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Identifier }}
  namespace: {{ .Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Identifier }}
    app.kubernetes.io/instance: {{ .Identifier }}
    app.kubernetes.io/component: app
    app.kubernetes.io/managed-by: cloudness
spec:
  progressDeadlineSeconds: 600  
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Identifier }}
      app.kubernetes.io/instance: {{ .Identifier }}
  template:
    metadata:
      annotations:
        cloudness.io/deployment-time: "{{ .UpdatedAt }}"
      labels:
        app.kubernetes.io/name: {{ .Identifier }}
        app.kubernetes.io/instance: {{ .Identifier }}
        app.kubernetes.io/component: app
        app.kubernetes.io/managed-by: cloudness
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: {{ .Identifier }}-sa
      terminationGracePeriodSeconds: 10
      automountServiceAccountToken: false
      enableServiceLinks: false
      hostNetwork: false
      hostPID: false
      hostIPC: false
      dnsPolicy: ClusterFirst
      containers:
      - name: app
        image: {{ .Image }}
        {{- if .Command }}
        command:
          {{- range .Command }}
        - {{ . }}
          {{- end }}
          {{- if .Args }}
        args:
            {{- range .Args }}
        - {{ . }}
            {{- end }}
          {{- end }}
        {{- end }}
        ports:
        {{- range $index, $value := .ServicePorts }}
        - containerPort: {{ $value }}
          protocol: TCP
          name: port-{{ $value }}
        {{- end }}
        env:
        # Unset Kubernetes service discovery environment variables
        - name: KUBERNETES_SERVICE_HOST
          value: ""
        - name: KUBERNETES_SERVICE_PORT
          value: ""
        - name: KUBERNETES_SERVICE_PORT_HTTPS
          value: ""
        - name: KUBERNETES_PORT
          value: ""
        - name: KUBERNETES_PORT_443_TCP
          value: ""
        - name: KUBERNETES_PORT_443_TCP_PROTO
          value: ""
        - name: KUBERNETES_PORT_443_TCP_PORT
          value: ""
        - name: KUBERNETES_PORT_443_TCP_ADDR
          value: ""
        {{- range $key, $value:= .Variables }}
        - name: {{ $key }} 
          valueFrom:
            configMapKeyRef:
              name: {{ $.Identifier }}
              key: {{ $key }}
        {{ end }}
        {{- range $key, $value := .Secrets }}
        - name: {{ $key }} 
          valueFrom:
            secretKeyRef:
              name: {{ $.Identifier }}
              key: {{ $key }}
        {{ end }}

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Identifier }}-hpa
  namespace: {{ .Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Identifier }}
    app.kubernetes.io/instance: {{ .Identifier }}
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/managed-by: cloudness
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Identifier }}
  minReplicas: 1
  maxReplicas: {{ .MaxReplicas }}  # Configurable Max Replicas
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75  # Scale up if CPU usage exceeds 75%
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75  # Scale up if Memory usage exceeds 75%
{{ end }}

{{ if .HasState }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Identifier }}
  namespace: {{ .Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Identifier }}
    app.kubernetes.io/instance: {{ .Identifier }}
    app.kubernetes.io/component: app
    app.kubernetes.io/managed-by: cloudness
spec:
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Identifier }}
      app.kubernetes.io/instance: {{ .Identifier }}
  template:
    metadata:
      annotations:
        cloudness.io/deployment-time: "{{ .UpdatedAt }}"
      labels:
        app.kubernetes.io/name: {{ .Identifier }}
        app.kubernetes.io/instance: {{ .Identifier }}
        app.kubernetes.io/component: app
        app.kubernetes.io/managed-by: cloudness
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: {{ .Identifier }}-sa
      terminationGracePeriodSeconds: 10
      automountServiceAccountToken: false
      enableServiceLinks: false
      hostNetwork: false
      hostPID: false
      hostIPC: false
      dnsPolicy: ClusterFirst
      containers:
      - name: app
        image: {{ .Image }}
        {{- if .Command }}
        command:
          {{- range .Command }}
        - {{ . }}
          {{- end }}
          {{- if .Args }}
        args:
            {{- range .Args }}
        - {{ . }}
            {{- end }}
          {{- end }}
        {{- end }}
        ports:
         {{- range $index, $value := .ServicePorts }}
        - containerPort: {{ $value }}
          protocol: TCP
          name: port-{{ $value }}
        {{- end }}
        volumeMounts:
        {{- range .Volumes }}
        - name: {{ .VolumeName }}
          mountPath: {{ .MountPath }}
        {{- end }}
        env:
        # Unset Kubernetes service discovery environment variables
        - name: KUBERNETES_SERVICE_HOST
          value: ""
        - name: KUBERNETES_SERVICE_PORT
          value: ""
        - name: KUBERNETES_SERVICE_PORT_HTTPS
          value: ""
        - name: KUBERNETES_PORT
          value: ""
        - name: KUBERNETES_PORT_443_TCP
          value: ""
        - name: KUBERNETES_PORT_443_TCP_PROTO
          value: ""
        - name: KUBERNETES_PORT_443_TCP_PORT
          value: ""
        - name: KUBERNETES_PORT_443_TCP_ADDR
          value: ""
        {{- range $key, $value:= .Variables }}
        - name: {{ $key }} 
          valueFrom:
            configMapKeyRef:
              name: {{ $.Identifier }}
              key: {{ $key }}
        {{ end }}
        {{- range $key, $value:= .Secrets }}
        - name: {{ $key }} 
          valueFrom:
            secretKeyRef:
              name: {{ $.Identifier }}
              key: {{ $key }}
        {{ end }}
      volumes:
      {{- range .Volumes }}
      - name: {{ .VolumeName }}
        persistentVolumeClaim:
          claimName: {{ .VolumeName }}
      {{- end }}
{{ end }}

{{ if gt (len .ServicePorts) 0 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .PrivateDomain }}
  namespace: {{ .Namespace }}
  labels:
    app.kubernetes.io/name: {{ .PrivateDomain }}
    app.kubernetes.io/instance: {{ .Identifier }}
    app.kubernetes.io/component: service
    app.kubernetes.io/managed-by: cloudness
spec:
  selector:
    app.kubernetes.io/name: {{ .Identifier }}
    app.kubernetes.io/instance: {{ .Identifier }}
  ports:
  {{- range $index, $value := .ServicePorts }}
  - name: {{ $value }}-port
    protocol: TCP
    appProtocol: {{ if and $.ServiceDomain $.ServiceDomain.Websecure }}kubernetes.io/wss{{ else }}kubernetes.io/ws{{ end }}
    port: {{ $value }}
    targetPort: {{ $value }}
  {{- end }}
{{ end }}
